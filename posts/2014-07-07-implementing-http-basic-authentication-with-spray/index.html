<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Implementing HTTP Basic authentication with Spray - Welcome to the π dimension</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Welcome to the π dimension" rel=home><div class="logo__item logo__text"><div class=logo__title>Welcome to the π dimension</div><div class=logo__tagline>Software development and other random ramblings</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Implementing HTTP Basic authentication with Spray</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2014-07-07T15:15:00+01:00>2014-07-07</time>
<time class=meta__text datetime=2021-03-31T19:14:34+02:00>(Last Modified: 2021-03-31)</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/Scala/ rel=category>Scala</a>, <a class=meta__link href=/categories/Akka/ rel=category>Akka</a>, <a class=meta__link href=/categories/Spray/ rel=category>Spray</a></span></div></div></header><div class="content post__content clearfix"><p>I&rsquo;ve been working with <a href=http://spray.io>Spray</a> for almost a year now and have been thinking of blogging about some of the things I&rsquo;ve found out during that time. After answering <a href=http://stackoverflow.com/questions/24501167/spray-authentication-method-with-basicauth/24511242#24511242>this question</a> on StackOverflow I realized I had most of a blog post there, so here&rsquo;s my attempt at explaining how to make HTTP Basic authentication work with Spray.</p><p>When implementing authentication for a REST API, I first came upon the <a href=https://github.com/spray/spray/wiki/Authentication-Authorization>Authentication and Authorization</a> page on the Spray wiki. That page says the documentation is for for Spray 0.9.0, however, I&rsquo;ve found most of it still applies as of Spray 1.3.1 running on Akka 2.3.4.</p><p>The first thing to understand is that there are two parts to the process:</p><ul><li><p><em>Authentication</em>, which validates the user&rsquo;s credentials (i.e, login and password, or perhaps an SSL client certificate) and creates some kind of object which carries the user&rsquo;s information.</p></li><li><p><em>Authorization</em>, which uses the data contained within that object to validate whether the user&rsquo;s action is allowed.</p></li></ul><p>First of all, I have an <code>ApiUser</code> class that holds the user&rsquo;s login and password. It could also hold additional info such as the user&rsquo;s name, email, etc. I use <a href=https://github.com/t3hnar/scala-bcrypt>scala-bcrypt</a> to hash the user&rsquo;s password, and added a <code>withPassword</code> method to set the user&rsquo;s password (which is never stored unencrypted) and a <code>passwordMatches</code> method which verifies if the user&rsquo;s password matches the given password. <code>hashedPassword</code> is an <code>Option[String]</code> so I can set it to <code>None</code> to disable a user&rsquo;s login.</p><pre><code>import com.github.t3hnar.bcrypt._
import org.mindrot.jbcrypt.BCrypt

case class ApiUser(login: String,
                   hashedPassword: Option[String] = None) {
  def withPassword(password: String) = copy (hashedPassword = Some(password.bcrypt(generateSalt)))
  
  def passwordMatches(password: String): Boolean = hashedPassword.exists(hp =&gt; BCrypt.checkpw(password, hp))
}
</code></pre><p>Once I had a class to hold the user&rsquo;s information, I created another class to carry the authenticated user&rsquo;s information and verify whether the user has permission to perform an action. I decided to create a separate case class to separate user information (name, email, etc.) from the details of authorization.</p><pre><code>class AuthInfo(val user: ApiUser) {
  def hasPermission(permission: String) = {
      // Code to verify whether user has the given permission      }
}
</code></pre><p>I am currently using Strings to identify permissions, although it is not recommended (search for &ldquo;stringly typed&rdquo; on your favorite search engine to find out why). This scheme can be as simple as always returning <code>true</code> (i.e., all authenticated users have access to all URIs) or can be extended to provide a full-fledged <a href=http://en.wikipedia.org/wiki/Role-based_access_control>RBAC</a> scheme</p><p>With this set up, we can go ahead with the authentication step. According to <a href=https://tools.ietf.org/html/rfc2617>RFC 2617</a>, when using HTTP Basic authentication the client must send an <code>Authorization</code> header such as the following:</p><pre><code>Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==
</code></pre><p>The string after <code>Basic</code> contains the userId and password, separated by a colon and encoded using Base64. If the <code>Authorization</code> header is not provided, or if the userid/password combination is incorrect, the server should reply with a <code>401 Unauthorized</code> status code, with the <code>WWW-Authenticate</code> header containing a <em>realm</em>. The realm is just a String to identify the server. Spray provides a <code>BasicAuth</code> class to take care of all that automatically in conjunction with the <code>authenticate</code> directive.</p><p>According to <a href=http://spray.io/documentation/1.2.1/spray-routing/security-directives/authenticate/>the Spray documentation</a>, the <code>authenticate</code> directive can receive either a <code>Future[Authentication[T]]</code> or a <code>ContextAuthenticator[T]</code>. A <code>ContextAuthenticator</code> is simply a method with that receives a <code>RequestContext</code> (which contains all the request information) and returns a <code>Future[Authentication[T]]</code>. Since we need to authenticate based on request data (in this case, the <code>Authorization</code> header), we need to use the second option.</p><p>Spray provides a <code>BasicAuth</code> class that extends <code>Authentication[T]</code> and takes care of decoding the login and password from the <code>Authorization</code> header, but we need to provide a function to do the authentication itself (i.e., validating the user and password) and return a <code>Future[Option[T]]</code>. In our case, <code>T</code> is our <code>AuthInfo</code> class, so it should return a <code>Future</code> containing <code>Some(authInfo)</code> if the login and password are valid, or <code>None</code> if they aren&rsquo;t. I found it most flexible to create a trait that can be mixed into any routes or into the Actor that runs the routes.</p><pre><code>trait Authenticator {
  def basicUserAuthenticator(implicit ec: ExecutionContext): AuthMagnet[AuthInfo] = {
    def validateUser(userPass: Option[UserPass]): Option[AuthInfo] = {
      for {
        p &lt;- userPass
        user &lt;- Repository.apiUsers(p.user)
        if user.passwordMatches(p.pass)
      } yield new AuthInfo(user)
    }

    def authenticator(userPass: Option[UserPass]): Future[Option[AuthInfo]] = future { validateUser(userPass) }

    BasicAuth(authenticator _, realm = &quot;Private API&quot;)
  }
}
</code></pre><p>In my application, <code>Repository.apiUsers</code> is an object with an <code>apply</code> method that receives the user&rsquo;s login and returns an <code>Option[ApiUser]</code>. You can replace it with, for example, a Slick query or a call to an LDAP server, depending on your application&rsquo;s needs. One of the nice things about Spray is that, since everything is a <code>Future</code>, those requests will happen asynchronously.</p><p>With this, we can mix the <code>Authenticator</code> trait into the Actor that runs the routes, and use the <code>authenticate</code> directive in those routes that need to be authenticated. <code>authenticate</code> will pass the <code>AuthInfo</code> object generated by the <code>validateUser</code> method as a parameter into its closure, and you can then use it wherever you need that info in your routes.</p><pre><code>class ApiActor extends Actor
                       with ActorLogging
                       with Authenticator {
  implicit val executionContext = context.dispatcher

  override def receive = {
    runRoute(
      pathEndOrSingleSlash {
        // Any user, authenticated or not, can enter here
        complete(&quot;System OK&quot;)
      } ~
      pathPrefix(&quot;api&quot;) {
        authenticate(basicUserAuthenticator) { authInfo =&gt;
          path(&quot;private&quot;) {
            get {
              // All authenticated users can enter here
              complete(s&quot;Hi, ${authInfo.user.login}&quot;)
            }
          }
        }
      }
    )
  }
</code></pre><p>What if you need more fine-grained authorization? For example, you might want to allow all users to GET a particular URI, but only some users to PUT or POST. That is what the <code>authorize</code> directive is for. <code>authorize</code> receives a by-name that returns <code>true</code> if the user is allowed to perform the action, and <code>false</code> if she isn&rsquo;t. You can use the <code>authInfo</code> object to check that.</p><pre><code>    authenticate(basicUserAuthenticator) { authInfo =&gt;
      path(&quot;private&quot;) {
        get {
            // All authenticated users can enter here
            complete(s&quot;Hi, ${authInfo.user.login}&quot;)
          }
          post {
            authorize(authInfo.hasPermission(&quot;post&quot;) {
              // Only those users that have the &quot;post&quot; permission will be allowed in here
            }              }
        }
      }
</code></pre><p>If the authorization is unsuccessful, Spray will return the HTTP <code>403 Forbidden</code> status code.</p><p>I hope this has been useful. At some point I would like to extend this to use multiple authentication schemes (starting with SSL Client Certificate and possibly continuing on to use OAuth), as well as extricate the code from the application I am working on and perhaps create a reusable library, but that will be for the future. For now, enjoy!</p></div></article></main><nav class="pager flex"><div class="pager__item pager__item--next"><a class=pager__link href=/posts/2015-12-06-scala-akka-and-docker-oh-my/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>Scala, Akka and Docker, oh my!</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"mcamou"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><aside class=sidebar><div class="widget-social widget"><h4 class="widget-social__title widget__title">Social</h4><div class="widget-social__content widget__content"><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Twitter rel="noopener noreferrer" href=https://twitter.com/thedoc target=_blank><svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5.0-78.8 35.3-78.8 78.8.0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6.0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1.0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4.0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9.0 224.1-120 224.1-224.1.0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg><span>Twitter</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=LinkedIn rel="noopener noreferrer" href=https://linkedin.com/in/mcamou target=_blank><svg class="widget-social__link-icon icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0 40v272c0 21.9 18.1 40 40 40h272c21.9.0 40-18.1 40-40V40c0-21.9-18.1-40-40-40H40C18.1.0.0 18.1.0 40zm312-8c4.6.0 8 3.4 8 8v272c0 4.6-3.4 8-8 8H40c-4.6.0-8-3.4-8-8V40c0-4.6 3.4-8 8-8H312zM59.5 87c0 15.2 12.3 27.5 27.5 27.5s27.5-12.3 27.5-27.5S102.2 59.5 87 59.5 59.5 71.8 59.5 87zM187 157h-1v-21h-45v152h47v-75c0-19.8 3.9-39 28.5-39 24.2.0 24.5 22.4 24.5 40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5 132.5 193.3 145.1 187 157zM64 288h47.5V136H64V288z"/></svg><span>LinkedIn</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=GitHub rel="noopener noreferrer" href=https://github.com/mcamou target=_blank><svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0C85.9.0.0 85.8.0 191.7c0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2.0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8.0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7.0.0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4.0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5.0 25.6-.2 46.3-.2 52.6.0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg><span>GitHub</span></a></div></div></div><div class="widget-search widget"><form class=widget-search__form role=search method=get action=https://google.com/search><label><input class=widget-search__field type=search placeholder=SEARCH… name=q aria-label=SEARCH…></label>
<input class=widget-search__submit type=submit value=Search>
<input type=hidden name=sitesearch value=https://mcamou.github.io/></form></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/posts/2015-12-06-scala-akka-and-docker-oh-my/>Scala, Akka and Docker, oh my!</a></li><li class=widget__item><a class=widget__link href=/posts/2014-07-07-implementing-http-basic-authentication-with-spray/>Implementing HTTP Basic authentication with Spray</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/Akka/>Akka</a></li><li class=widget__item><a class=widget__link href=/categories/Docker/>Docker</a></li><li class=widget__item><a class=widget__link href=/categories/Scala/>Scala</a></li><li class=widget__item><a class=widget__link href=/categories/Spray/>Spray</a></li></ul></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Mario Camou.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>